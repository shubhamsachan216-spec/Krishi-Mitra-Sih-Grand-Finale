<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="doc_title">Krishi Mitra - Smart Farming Solution | Soil Analysis</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kannada:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&family=Poppins:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#38784E',
                        'secondary-green': '#51A36D',
                        'accent-blue': '#2563EB',
                    },
                }
            },
            plugins: [],
        }
    </script>

    <style>
        /* Page colors & base */
        body { background-color: #f3f8f3; color: #0b3b2e; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

        /* Tailwind @apply fallback for inputs (for non-PostCSS) */
        input[type="number"], select, input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #c7e5d2;
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box;
        }

        /* OUTPUT: Minimal flat bar gauges */
        .bar-row { display:flex; align-items:center; gap:12px; }
        .bar-label { width:120px; font-weight:600; color:#0b3b2e; text-align:left; font-size:0.95rem; }
        .bar-wrap { flex:1; background:#e6f2ea; border-radius:12px; padding:6px; position:relative; overflow:hidden; }
        .bar-fill {
            height:28px;
            width:0%;
            border-radius:10px;
            transition: width 700ms cubic-bezier(.2,.9,.2,1), background 400ms ease;
            display:flex;
            align-items:center;
            justify-content:flex-end;
            padding-right:10px;
            color:white;
            font-weight:700;
            font-size:0.95rem;
        }
        .bar-value { font-size:0.85rem; margin-left:8px; color:#0b3b2e; min-width:48px; text-align:right; }

        /* small screens tweak */
        @media (max-width:640px){
            .bar-label { width:100px; font-size:0.9rem; }
            .bar-value { min-width:40px; }
        }

        /* subtle card animation */
        #output { transform: translateY(6px); opacity: 0; transition: all 300ms ease; }
        #output.show { transform: translateY(0); opacity: 1; }

        /* observation list spacing */
        #analysisText ul { margin-top:6px; }
        #analysisText li { margin-bottom:6px; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <header class="flex gap-3 items-center mb-4">
            <div>
                <h1 class="text-xl font-bold m-0 text-primary-green">Krishi Mitra â€” Soil Analysis</h1>
                <div class="text-sm text-gray-500">Quick test â€¢ PDF report â€¢ Offline saved</div>
            </div>
        </header>

        <section class="bg-white rounded-xl p-4 shadow-lg mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                
                <div>
                    <label for="plannedCrop" class="block text-sm text-gray-500 mb-1">Planned Crop</label>
                    <select id="plannedCrop" class="focus:ring-primary-green focus:border-primary-green">
                        <option value="">Select Target Crop</option>
                        <option>Wheat</option>
                        <option>Rice</option>
                        <option>Sugarcane</option>
                        <option>Maize</option>
                        <option>Cotton</option>
                        <option>Tomato</option>
                    </select>
                </div>
                
                <div>
                    <label for="ph" class="block text-sm text-gray-500 mb-1">pH</label>
                    <input id="ph" type="number" step="0.1" min="0" max="14" placeholder="e.g. 6.8" class="focus:ring-primary-green focus:border-primary-green">
                </div>
                <div>
                    <label for="soilType" class="block text-sm text-gray-500 mb-1">Soil Type</label>
                    <select id="soilType" class="focus:ring-primary-green focus:border-primary-green">
                        <option value="">Select soil type</option>
                        <option>Loamy</option>
                        <option>Sandy</option>
                        <option>Clay</option>
                        <option>Black</option>
                        <option>Red</option>
                    </select>
                </div>

                <div>
                    <label for="nitrogen" class="block text-sm text-gray-500 mb-1">Nitrogen (N) â€” kg/ha</label>
                    <input id="nitrogen" type="number" step="1" placeholder="e.g. 120" class="focus:ring-primary-green focus:border-primary-green">
                </div>
                <div>
                    <label for="phosphorus" class="block text-sm text-gray-500 mb-1">Phosphorus (P) â€” kg/ha</label>
                    <input id="phosphorus" type="number" step="1" placeholder="e.g. 30" class="focus:ring-primary-green focus:border-primary-green">
                </div>

                <div>
                    <label for="potassium" class="block text-sm text-gray-500 mb-1">Potassium (K) â€” kg/ha</label>
                    <input id="potassium" type="number" step="1" placeholder="e.g. 90" class="focus:ring-primary-green focus:border-primary-green">
                </div>
                <div>
                    <label for="moisture" class="block text-sm text-gray-500 mb-1">Moisture (%)</label>
                    <input id="moisture" type="number" step="0.1" placeholder="e.g. 18" class="focus:ring-primary-green focus:border-primary-green">
                </div>

                <div>
                    <label for="oc" class="block text-sm text-gray-500 mb-1">Organic Carbon (%)</label>
                    <input id="oc" type="number" step="0.01" placeholder="e.g. 0.7" class="focus:ring-primary-green focus:border-primary-green">
                </div>

                <div>
                    <label for="rainfall" class="block text-sm text-gray-500 mb-1">7-Day Rain Forecast (mm) â€” e.g. 0,5,0,0,10,0,0</label>
                    <input id="rainfall" type="text" placeholder="7 comma-separated values (optional)" class="focus:ring-primary-green focus:border-primary-green">
                </div>

                <div>
                    <label for="farmerName" class="block text-sm text-gray-500 mb-1">Farmer / Field ID</label>
                    <input id="farmerName" type="text" placeholder="Name or field id (required for history)" class="focus:ring-primary-green focus:border-primary-green">
                </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                <input id="fileUpload" type="file" accept=".pdf,.txt,.doc,.docx" class="p-2 border border-green-300 rounded-lg text-sm flex-grow min-w-40"/>
                
                <button id="parseBtn" class="bg-white border border-green-300 text-green-700 hover:bg-green-50 text-sm px-3 py-2 rounded-lg transition duration-150 whitespace-nowrap">
                    Parse file
                </button>
                <button id="voiceBtn" class="bg-white border border-green-300 text-green-700 hover:bg-green-50 text-sm px-3 py-2 rounded-lg transition duration-150 whitespace-nowrap">
                    ðŸŽ¤ Voice input
                </button>
                
                <button id="analyzeBtn" class="bg-primary-green text-white hover:bg-green-700 text-sm px-3 py-2 rounded-lg transition duration-150 font-semibold whitespace-nowrap">
                    Analyze Soil
                </button>
                
                <button id="saveBtn" class="bg-white border border-green-300 text-green-700 hover:bg-green-50 text-sm px-3 py-2 rounded-lg transition duration-150 whitespace-nowrap">
                    Save Current
                </button>
                <button id="loadBtn" class="bg-white border border-green-300 text-green-700 hover:bg-green-50 text-sm px-3 py-2 rounded-lg transition duration-150 whitespace-nowrap">
                    Load Last
                </button>
                <button id="historyBtn" class="bg-accent-blue text-white hover:bg-blue-700 text-sm px-3 py-2 rounded-lg transition duration-150 font-semibold whitespace-nowrap">
                    View Trends
                </button>
                
                <button id="pdfBtn" class="bg-primary-green text-white hover:bg-green-700 text-sm px-3 py-2 rounded-lg transition duration-150 font-semibold whitespace-nowrap">
                    Generate PDF
                </button>
            </div>

            <div id="message" class="mt-3 p-3 rounded-lg border border-green-300 bg-green-50 text-sm text-green-900" style="display:none"></div>
        </section>

        <section id="output" class="bg-white rounded-xl p-6 shadow-lg mb-4" style="display:none">
            <div class="flex justify-between items-center flex-wrap gap-3">
                <div>
                    <div id="overallTag" class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">Status</div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500" id="dateTime"></div>
                </div>
            </div>

            <hr class="my-4 border-green-100">

            <div class="space-y-3 mb-4">
                <div class="bar-row">
                    <div class="bar-label">pH</div>
                    <div class="bar-wrap" id="bar_ph_wrap"><div id="bar_ph" class="bar-fill">â€”</div></div>
                    <div class="bar-value" id="val_ph">â€”</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Nitrogen (N)</div>
                    <div class="bar-wrap" id="bar_n_wrap"><div id="bar_n" class="bar-fill">â€”</div></div>
                    <div class="bar-value" id="val_n">â€”</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Phosphorus (P)</div>
                    <div class="bar-wrap" id="bar_p_wrap"><div id="bar_p" class="bar-fill">â€”</div></div>
                    <div class="bar-value" id="val_p">â€”</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Potassium (K)</div>
                    <div class="bar-wrap" id="bar_k_wrap"><div id="bar_k" class="bar-fill">â€”</div></div>
                    <div class="bar-value" id="val_k">â€”</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Moisture</div>
                    <div class="bar-wrap" id="bar_moisture_wrap"><div id="bar_moisture" class="bar-fill">â€”</div></div>
                    <div class="bar-value" id="val_moisture">â€”</div>
                </div>

                <div class="bar-row">
                    <div class="bar-label">Organic Carbon (OC)</div>
                    <div class="bar-wrap" id="bar_oc_wrap"><div id="bar_oc" class="bar-fill">â€”</div></div>
                    <div class="bar-value" id="val_oc">â€”</div>
                </div>
            </div>

            <div id="analysisText" class="text-gray-800 text-base leading-7 p-4 bg-gray-50 rounded-xl shadow-inner"></div>

            <h3 class="mt-6 text-lg font-bold text-accent-blue flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600"></i> Soil History & Trend
            </h3>
            <div id="historyTrends" class="text-gray-700 p-4 rounded-xl bg-blue-50 shadow-inner">No history data loaded or available for this field.</div>

            <h3 class="mt-6 text-lg font-bold text-primary-green flex items-center gap-2">
                <i class="fa-solid fa-seedling text-green-600"></i> Recommendations (for <span id="cropTitle">Selected Crop</span>)
            </h3>
            <div id="recommendations" class="text-gray-700 p-4 rounded-xl bg-green-50 shadow-inner"></div>

            <h3 class="mt-6 text-lg font-bold text-primary-green flex items-center gap-2">
                <i class="fa-solid fa-cloud-rain text-cyan-600"></i> 7-Day Soil Moisture Forecast
            </h3>
            <div id="moistureForecast" class="text-gray-700 p-4 bg-cyan-50 rounded-xl shadow-inner"></div>

            <h3 class="mt-6 text-lg font-bold text-primary-green flex items-center gap-2">
                <i class="fa-solid fa-flask text-green-700"></i> Fertilizer Calculator (approx per acre)
            </h3>
            <div id="fertCalc" class="text-gray-700 p-4 bg-gray-100 rounded-xl shadow-inner"></div>
        </section>

        <footer class="bg-white rounded-xl p-4 shadow-lg text-center text-sm text-gray-500">
            <div>Built for Krishi Mitra â€” available features: manual, file parse, voice, PDF, offline.</div>
        </footer>
    </div>

    <script>
    // Self-Invoking Function to encapsulate the Soil Analysis logic
    (async function(){
        const phEl = document.getElementById('ph');
        const nEl = document.getElementById('nitrogen');
        const pEl = document.getElementById('phosphorus');
        const kEl = document.getElementById('potassium');
        const mEl = document.getElementById('moisture');
        const ocEl = document.getElementById('oc');
        const soilTypeEl = document.getElementById('soilType');
        const farmerNameEl = document.getElementById('farmerName');
        const plannedCropEl = document.getElementById('plannedCrop'); // NEW
        const rainfallEl = document.getElementById('rainfall'); // NEW
        
        const message = document.getElementById('message');
        const output = document.getElementById('output');
        const analysisText = document.getElementById('analysisText');
        const recommendations = document.getElementById('recommendations');
        const fertCalc = document.getElementById('fertCalc');
        const overallTag = document.getElementById('overallTag');
        const dateTime = document.getElementById('dateTime');
        const moistureForecastEl = document.getElementById('moistureForecast'); // NEW
        const historyTrendsEl = document.getElementById('historyTrends'); // NEW
        const cropTitleEl = document.getElementById('cropTitle'); // NEW

        // NPK and pH Targets for specific crops (Target N, P2O5, K2O in kg/ha)
        const cropTargets = {
            'Wheat': { ph: [6.0, 7.5], n_target: 150, p_target: 35, k_target: 180, n_low: 110, p_low: 25, k_low: 120 },
            'Rice': { ph: [5.5, 6.5], n_target: 120, p_target: 25, k_target: 100, n_low: 80, p_low: 15, k_low: 70 },
            'Sugarcane': { ph: [6.5, 7.5], n_target: 250, p_target: 50, k_target: 150, n_low: 200, p_low: 40, k_low: 100 },
            'Maize': { ph: [6.0, 7.5], n_target: 160, p_target: 40, k_target: 100, n_low: 120, p_low: 30, k_low: 70 },
            'Cotton': { ph: [6.0, 7.5], n_target: 120, p_target: 30, k_target: 100, n_low: 90, p_low: 20, k_low: 70 },
            'Tomato': { ph: [6.0, 7.0], n_target: 180, p_target: 50, k_target: 220, n_low: 140, p_low: 40, k_low: 180 },
        };

        function nowStr(){
            return new Date().toLocaleString();
        }
        dateTime.textContent = nowStr();

        function showMessage(txt, isError=false){
            message.style.display='block';
            message.innerHTML = txt;
            if(isError){
                message.className = 'mt-3 p-3 rounded-lg border border-red-300 bg-red-50 text-sm text-red-900';
            } else {
                message.className = 'mt-3 p-3 rounded-lg border border-green-300 bg-green-50 text-sm text-green-900';
            }
        }

        function hideMessage(){ message.style.display='none'; }

        // NEW: Function to predict soil moisture
        function predictMoisture(currentM, soilType, rainForecast, days = 7) {
            currentM = +currentM;
            const evapRateBase = { 'Sandy': 0.8, 'Loamy': 0.6, 'Clay': 0.4 }[soilType] || 0.6; // daily % moisture loss
            let results = [];
            let moisture = currentM;

            if(!currentM || !rainForecast || rainForecast.length < days){
                return { status: 'Missing Data', results: [] };
            }

            for(let d=0; d<days; d++){
                // Evapotranspiration: simple model - higher temp/drier soil -> faster drop
                const tempFactor = 1.0; // Assume average day, no complex temp data
                const drop = (evapRateBase * tempFactor) + (10 / (moisture + 1)); // drop accelerates as moisture gets very low
                
                moisture = moisture - drop + (rainForecast[d] / 8); // Simple: 8mm rain = +1% moisture (depends on soil capacity)
                moisture = Math.max(0, Math.min(100, moisture));

                let action = '';
                if(moisture < 12) action = 'IRRIGATE NOW';
                else if(moisture < 18) action = 'Monitor Closely';
                else action = 'OK';
                
                results.push({ day: d+1, rain: rainForecast[d], moisture: moisture.toFixed(1), action });
            }
            return { status: 'Forecast Complete', results };
        }
        
        // NEW: Function to save historical data
        function saveHistoricalData(result, values){
            const fieldId = values.farmerName;
            if(!fieldId){ return; }

            const fieldKey = 'krishi_soil_history_' + fieldId.toLowerCase().replace(/\s/g, '_');
            let history = JSON.parse(localStorage.getItem(fieldKey) || '[]');
            
            // Only save the key parameters for trend analysis
            history.push({ 
                timestamp: result.timestamp, 
                ph: values.ph ? +values.ph : null, 
                n: values.n ? +values.n : null, 
                p: values.p ? +values.p : null, 
                k: values.k ? +values.k : null, 
                oc: values.oc ? +values.oc : null
            });

            // Keep only the last 10 tests for storage
            if (history.length > 10) history = history.slice(history.length - 10);
            localStorage.setItem(fieldKey, JSON.stringify(history));
        }

        // NEW: Function to analyze trends
        function analyzeTrends(fieldId){
            const fieldKey = 'krishi_soil_history_' + fieldId.toLowerCase().replace(/\s/g, '_');
            const history = JSON.parse(localStorage.getItem(fieldKey) || '[]');
            
            if(history.length < 2) return { trend: ['Need at least 2 saved tests for trend analysis.'], data: history };
            
            const latest = history[history.length - 1];
            const previous = history[history.length - 2];
            let trends = [];

            // Compare latest to previous
            ['ph', 'n', 'p', 'k', 'oc'].forEach(key => {
                if(latest[key] !== null && previous[key] !== null){
                    const diff = latest[key] - previous[key];
                    const changePct = previous[key] === 0 ? 0 : (diff / previous[key]) * 100;
                    const param = key.toUpperCase();
                    
                    if(Math.abs(diff) < 0.05 && param !== 'PH'){
                        trends.push(`â€¢ ${param} is stable since last test.`);
                    } else if(diff > 0){
                        trends.push(`â€¢ ${param} has **increased** by ${Math.abs(changePct).toFixed(1)}% (${diff.toFixed(2)}).`);
                    } else if (diff < 0){
                        trends.push(`â€¢ ${param} has **decreased** by ${Math.abs(changePct).toFixed(1)}% (${diff.toFixed(2)}).`);
                    }
                }
            });

            if(trends.length === 0) trends.push('No comparable data points found between the last two tests.');

            return { trend: trends, data: history };
        }


        // Basic rule-based analyis
        function analyze(values){
            const {ph, n, p, k, moisture, oc, soilType, farmerName, plannedCrop} = values;
            const target = plannedCrop ? cropTargets[plannedCrop] : null;
            let status = 'Normal';
            let notes = [];
            let rec = [];

            // --- pH analysis (General/Crop Specific) ---
            if(ph === null || ph === undefined || ph === '') notes.push('pH not provided');
            else {
                const phv = +ph;
                const phRange = target ? target.ph : [6.0, 7.5]; // Default range

                if(phv < phRange[0]) { 
                    notes.push(`Too acidic (pH ${phv} < ${phRange[0]}). Low Zinc and Phosphorus availability.`); 
                    rec.push('Apply lime (calcium carbonate) as per soil test'); 
                    status='Problem'; 
                }
                else if(phv > phRange[1]) { 
                    notes.push(`Alkaline (pH ${phv} > ${phRange[1]}). Micronutrients may be locked.`); 
                    rec.push('Use organic matter, gypsum for sodic soils'); 
                    status='Problem'; 
                }
                else { notes.push(`pH ${phv} is OPTIMAL for ${plannedCrop || 'most crops'}.`); }
            }

            // --- NPK analysis (Crop Specific) ---
            const npkCheck = [
                { key: 'n', val: n, label: 'Nitrogen', unit: 'kg/ha', target_low: target?.n_low || 100, target_med: target?.n_target || 200, fert: 'Urea' },
                { key: 'p', val: p, label: 'Phosphorus', unit: 'kg/ha', target_low: target?.p_low || 20, target_med: target?.p_target || 40, fert: 'DAP or Single Super Phosphate' },
                { key: 'k', val: k, label: 'Potassium', unit: 'kg/ha', target_low: target?.k_low || 100, target_med: target?.k_target || 250, fert: 'Muriate of Potash' }
            ];

            npkCheck.forEach(item => {
                if(item.val === '' || item.val === null){ notes.push(`${item.label} not provided`); return; } 
                
                const vv = +item.val;
                if(vv < item.target_low){ 
                    notes.push(`${item.label} LOW. Current: ${vv} ${item.unit} (Target Low: ${item.target_low}).`); 
                    rec.push(`Apply ${item.fert} to bridge the gap.`); 
                    status='Problem'; 
                }
                else if(vv < item.target_med){ 
                    notes.push(`${item.label} medium. Current: ${vv} ${item.unit}.`); 
                    rec.push(`Top up with balanced fertilizer for optimal yield of ${plannedCrop}.`); 
                }
                else { notes.push(`${item.label} adequate.`); }
            });

            // --- Moisture and OC guidance ---
            if(moisture !== '' && moisture !== null){
                const mv = +moisture;
                if(mv < 12) { notes.push('Soil moisture critically low â€” urgent irrigation needed.'); rec.push('Initiate irrigation immediately.'); status='Problem'; }
                else if(mv < 18){ notes.push('Soil moisture low â€” consider irrigation or mulching'); rec.push('Irrigate / mulch'); }
                else if(mv > 30){ notes.push('Soil moisture high â€” check drainage'); }
                else { notes.push('Soil moisture OK'); }
            }

            if(oc !== '' && oc !== null){
                const ocv = +oc;
                if(ocv < 0.5){ notes.push('Organic carbon critically low â€” add compost/FYM'); rec.push('Add farmyard manure or compost (1-2 tons/acre)'); status='Problem'; }
                else if(ocv < 0.7){ notes.push('Organic carbon low â€” requires moderate addition of organic matter'); rec.push('Add organic matter regularly.'); }
                else { notes.push('Organic carbon acceptable'); }
            }

            // Crop suggestions: simple rules, unless a crop is selected
            let crops = [];
            if(!plannedCrop){
                if(ph !== '' && ph !== null){
                    const phv = +ph;
                    if(phv >= 6 && phv <= 7.5){ crops.push('Wheat, Sugarcane, Vegetables'); }
                    if(phv < 6){ crops.push('Rice, Tea (acidic tolerant)'); }
                    if(phv > 7.5){ crops.push('Barley, Mustard, Chickpea'); }
                }
                if(soilType){
                    if(soilType.toLowerCase().includes('sandy')) crops.push('Groundnut, Pearl millet (Bajra)');
                    if(soilType.toLowerCase().includes('clay')) crops.push('Rice, Sugarcane, Cotton');
                    if(soilType.toLowerCase().includes('loamy')) crops.push('Wheat, Vegetables, Maize');
                }
            } else {
                crops.push(plannedCrop); // Priority to the selected crop
            }

            // deduplicate crops
            crops = Array.from(new Set(crops)).slice(0,5);

            // Fertilizer calculator (approx, per acre) - NOW CROP-SPECIFIC IF TARGET IS SET
            function calcFertilizer(n, p, k, target){
                const perAcre = {};
                const N_ACRE_TARGET = target?.n_target ? target.n_target / 2.5 : 40; // Approx kg/acre
                const P_ACRE_TARGET = target?.p_target ? target.p_target / 2.5 : 20;
                const K_ACRE_TARGET = target?.k_target ? target.k_target / 2.5 : 30;

                const N_DEFICIENCY = n !== '' && n !== null && +n < (target?.n_low || 100) ? N_ACRE_TARGET : 0;
                const P_DEFICIENCY = p !== '' && p !== null && +p < (target?.p_low || 20) ? P_ACRE_TARGET : 0;
                const K_DEFICIENCY = k !== '' && k !== null && +k < (target?.k_low || 100) ? K_ACRE_TARGET : 0;
                
                // Adjust for DAP and NPK complexity in real life (simplified here)
                
                // N: Urea has 46% N => kg needed = desiredN / 0.46
                if(N_DEFICIENCY > 0){
                    perAcre.urea = Math.round(N_DEFICIENCY / 0.46);
                }
                // P: DAP ~ 46% P2O5 -> desired P2O5
                if(P_DEFICIENCY > 0){
                    perAcre.dap = Math.round(P_DEFICIENCY / 0.46);
                }
                // K: MOP (Muriate of potash) ~ 60% K2O; desired K2O
                if(K_DEFICIENCY > 0){
                    perAcre.mop = Math.round(K_DEFICIENCY / 0.60);
                }
                return perAcre;
            }

            const fert = calcFertilizer(n,p,k, target);

            return {status, notes, rec, crops, fert, farmerName, plannedCrop, timestamp: new Date().toISOString()};
        }

        // Update minimal flat bar gauge (valueNormalization: value, min, max)
        function updateBar(idFill, idVal, value, min, max, unit="", targetMin=null, targetMax=null){
            const fill = document.getElementById(idFill);
            const display = document.getElementById(idVal);

            // if missing or empty, show dash
            if(value === '' || value === null || value === undefined || isNaN(+value)){
                fill.style.width = '0%';
                fill.style.background = '#94a3b8'; // gray
                fill.textContent = 'â€”';
                display.textContent = 'â€”';
                return;
            }

            const v = +value;
            let pct;
            
            // Special handling for pH (different scale)
            if(idFill === 'bar_ph'){
                const idealLow = targetMin !== null ? targetMin : 6.0;
                const idealHigh = targetMax !== null ? targetMax : 7.5;
                const distance = Math.max(0, Math.max(idealLow - v, v - idealHigh));
                const dPct = Math.round(Math.max(0, 100 - (distance / 3) * 100));
                pct = Math.max(0, Math.min(100, dPct));
            } else {
                // Map value to 0-100 percent using min..max (clamped)
                if(max === min) pct = 0;
                else pct = Math.round(((v - min) / (max - min)) * 100);
                pct = Math.max(0, Math.min(100, pct));
            }

            // Choose color by thresholds (percent-based)
            let color = '#16a34a'; // green
            if(pct < 40) color = '#ef4444'; // red
            else if(pct < 70) color = '#f59e0b'; // orange

            fill.style.width = pct + '%';
            fill.style.background = color;
            // show value with unit
            const show = unit ? (v + unit) : (Number.isInteger(v) ? v : (Math.round(v*10)/10));
            fill.textContent = show;
            display.textContent = show;
        }

        // Wrapper to update all bars from values object
        function updateAllBars(values){
            const target = values.plannedCrop ? cropTargets[values.plannedCrop] : null;

            // pH: min 0, max 14 (using crop target ranges for color/score)
            updateBar('bar_ph','val_ph', values.ph, 0, 14, '', target?.ph[0], target?.ph[1]);

            // NPK: using crop target maximums for better scaling if available
            updateBar('bar_n','val_n', values.n, 0, target?.n_target * 1.5 || 300, '');

            updateBar('bar_p','val_p', values.p, 0, target?.p_target * 1.5 || 150, '');

            updateBar('bar_k','val_k', values.k, 0, target?.k_target * 1.5 || 300, '');

            // Moisture: 0..100 %
            updateBar('bar_moisture','val_moisture', values.moisture, 0, 100, '%');

            // Organic Carbon: 0..2% (typical range)
            updateBar('bar_oc','val_oc', values.oc, 0, 2, '%');
        }

        function renderAnalysis(result, values){
            output.style.display='block';
            output.classList.remove('show');
            setTimeout(()=> output.classList.add('show'), 10);

            // Set tag colors based on status (Tailwind classes)
            if(result.status === 'Normal'){
                overallTag.textContent = 'Optimal Health';
                overallTag.className = 'inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold';
            } else {
                overallTag.textContent = `Problem (${result.status})`;
                overallTag.className = 'inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold';
            }

            cropTitleEl.textContent = values.plannedCrop || 'General Crop Suitability';

            analysisText.innerHTML = '';
            analysisText.innerHTML += '<b>Field:</b> ' + (values.farmerName || 'â€”') + ' â€¢ <b>Target Crop:</b> ' + (values.plannedCrop || 'None') + '<br>';
            analysisText.innerHTML += '<b>pH:</b> ' + (values.ph ?? 'â€”') + ' â€¢ <b>N:</b> '+(values.n ?? 'â€”')+' â€¢ <b>P:</b> '+(values.p ?? 'â€”')+' â€¢ <b>K:</b> '+(values.k ?? 'â€”') +'<br>';
            analysisText.innerHTML += '<b>Moisture:</b> ' + (values.moisture ?? 'â€”') + '% â€¢ <b>OC:</b> ' + (values.oc ?? 'â€”') + '% â€¢ <b>Soil Type:</b> ' + (values.soilType || 'â€”') + '<br>';
            analysisText.innerHTML += '<hr class="my-2 border-green-100">';

            analysisText.innerHTML += '<b>Observations:</b><ul class="list-disc list-inside space-y-0.5 mt-1">';
            result.notes.forEach(n => { analysisText.innerHTML += '<li>' + n + '</li>'; });
            analysisText.innerHTML += '</ul>';

            recommendations.innerHTML = '';
            if(result.crops.length && !values.plannedCrop) recommendations.innerHTML += '<p class="mb-1"><b>Suggested Crops:</b> ' + result.crops.join(', ') + '</p>';
            if(result.rec.length){
                recommendations.innerHTML += '<b>Immediate Actions:</b><ul class="list-disc list-inside space-y-0.5 mt-1">';
                result.rec.forEach(r => recommendations.innerHTML += '<li>' + r + '</li>');
                recommendations.innerHTML += '</ul>';
            } else {
                recommendations.innerHTML = 'No immediate critical actions required based on current parameters.';
            }

            fertCalc.innerHTML = '';
            if(Object.keys(result.fert).length === 0) fertCalc.innerHTML = 'No major fertilizer additions required based on low/medium thresholds.';
            else {
                fertCalc.innerHTML += '<p>Estimated fertilizer need to reach LOW/MEDIUM threshold for the selected crop:</p>';
                fertCalc.innerHTML += '<ul class="list-disc list-inside space-y-0.5 mt-1">';
                if(result.fert.urea) fertCalc.innerHTML += '<li>Urea (46% N): <b>' + result.fert.urea + ' kg/acre</b> (approx)</li>';
                if(result.fert.dap) fertCalc.innerHTML += '<li>DAP (18% N, 46% P2O5): <b>' + result.fert.dap + ' kg/acre</b> (approx)</li>';
                if(result.fert.mop) fertCalc.innerHTML += '<li>MOP (60% K2O): <b>' + result.fert.mop + ' kg/acre</b> (approx)</li>';
                fertCalc.innerHTML += '</ul>';
            }

            // NEW: Render Moisture Forecast
            const rainForecast = (values.rainfall || '').split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            const forecast = predictMoisture(values.moisture, values.soilType, rainForecast, 7);
            
            moistureForecastEl.innerHTML = '';
            if(forecast.status === 'Missing Data'){
                moistureForecastEl.innerHTML = 'Forecast data missing. Please provide current Moisture (%) and 7-Day Rain Forecast.';
            } else {
                moistureForecastEl.innerHTML += '<table class="w-full text-left table-auto">';
                moistureForecastEl.innerHTML += '<thead><tr class="border-b border-cyan-200"><th class="py-1 px-1">Day</th><th class="py-1 px-1">Rain (mm)</th><th class="py-1 px-1">Est. Moisture (%)</th><th class="py-1 px-1">Action</th></tr></thead><tbody>';
                forecast.results.forEach(r => {
                    const color = r.action.includes('IRRIGATE') ? 'text-red-600 font-bold' : (r.action.includes('Monitor') ? 'text-orange-600' : 'text-green-600');
                    moistureForecastEl.innerHTML += `<tr><td class="py-1 px-1">Day ${r.day}</td><td class="py-1 px-1">${r.rain}</td><td class="py-1 px-1">${r.moisture}%</td><td class="py-1 px-1 ${color}">${r.action}</td></tr>`;
                });
                moistureForecastEl.innerHTML += '</tbody></table>';
                moistureForecastEl.innerHTML += '<p class="mt-2 text-sm text-gray-600">Note: This is an estimation. Actual results depend on temperature, wind, and crop.</p>';
            }

            // NEW: Render Trends
            const trends = analyzeTrends(values.farmerName);
            historyTrendsEl.innerHTML = '';
            historyTrendsEl.innerHTML += '<p class="mb-2 font-semibold">Latest Test (' + new Date(result.timestamp).toLocaleDateString() + '):</p>';
            historyTrendsEl.innerHTML += '<ul class="list-disc list-inside space-y-0.5">' + trends.trend.map(t => `<li>${t}</li>`).join('') + '</ul>';

            dateTime.textContent = new Date(result.timestamp).toLocaleString();
            updateAllBars(values);
        }

        // Analyze button
        document.getElementById('analyzeBtn').addEventListener('click', ()=>{
            hideMessage();
            const values = {
                ph: phEl.value, n: nEl.value, p: pEl.value, k: kEl.value,
                moisture: mEl.value, oc: ocEl.value, soilType: soilTypeEl.value, 
                farmerName: farmerNameEl.value, plannedCrop: plannedCropEl.value,
                rainfall: rainfallEl.value // NEW
            };
            const res = analyze(values);
            renderAnalysis(res, values);
            
            // store last result for offline & history
            localStorage.setItem('krishi_soil_last', JSON.stringify({values, res}));
            saveHistoricalData(res, values); // NEW: Save to history
            showMessage('Analysis complete â€” saved as last test and added to field history.');
        });

        // Save locally explicit
        document.getElementById('saveBtn').addEventListener('click', ()=>{
            const values = {
                ph: phEl.value, n: nEl.value, p: pEl.value, k: kEl.value,
                moisture: mEl.value, oc: ocEl.value, soilType: soilTypeEl.value, 
                farmerName: farmerNameEl.value, plannedCrop: plannedCropEl.value,
                rainfall: rainfallEl.value 
            };
            localStorage.setItem('krishi_soil_last', JSON.stringify({values, savedAt: new Date().toISOString()}));
            showMessage('Current form data saved locally (browser storage).');
        });

        // Load saved
        document.getElementById('loadBtn').addEventListener('click', ()=>{
            const raw = localStorage.getItem('krishi_soil_last');
            if(!raw){ showMessage('No saved test found.', true); return; }
            let parsed = {};
            try{ parsed = JSON.parse(raw); } catch(e){ showMessage('Saved data corrupted.', true); return; }
            const vals = parsed.values || parsed;
            
            phEl.value = vals.ph || '';
            nEl.value = vals.n || '';
            pEl.value = vals.p || '';
            kEl.value = vals.k || '';
            mEl.value = vals.moisture || '';
            ocEl.value = vals.oc || '';
            soilTypeEl.value = vals.soilType || '';
            farmerNameEl.value = vals.farmerName || '';
            plannedCropEl.value = vals.plannedCrop || ''; // NEW
            rainfallEl.value = vals.rainfall || ''; // NEW

            showMessage('Loaded last saved test. Press Analyze to re-run recommendations.');
        });
        
        // NEW: View Trends button handler
        document.getElementById('historyBtn').addEventListener('click', ()=>{
            const fieldId = farmerNameEl.value;
            if(!fieldId){ showMessage('Please enter a Field ID/Farmer Name to view trends.', true); return; }
            
            const trends = analyzeTrends(fieldId);
            if(trends.data.length < 1){ 
                showMessage(`No history found for field: ${fieldId}.`, true); 
                historyTrendsEl.innerHTML = `No history data available for field: ${fieldId}. Run an analysis and save to start tracking.`;
                return; 
            }
            
            output.style.display='block';
            output.classList.remove('show');
            setTimeout(()=> output.classList.add('show'), 10);
            
            // Only update the trends section on this click
            historyTrendsEl.innerHTML = '';
            historyTrendsEl.innerHTML += '<p class="mb-2 font-semibold">Field: ' + fieldId + '</p>';
            historyTrendsEl.innerHTML += '<p class="mb-2">Last Test Date: ' + new Date(trends.data[trends.data.length - 1].timestamp).toLocaleDateString() + '</p>';
            historyTrendsEl.innerHTML += '<ul class="list-disc list-inside space-y-0.5">' + trends.trend.map(t => `<li>${t}</li>`).join('') + '</ul>';
            showMessage(`Displaying trends for ${fieldId}. Total ${trends.data.length} records found.`);
        });

        // PDF export - needs update to include new fields in PDF logic
        document.getElementById('pdfBtn').addEventListener('click', async ()=>{
            const raw = localStorage.getItem('krishi_soil_last');
            let snapshot = {};
            if(raw) snapshot = JSON.parse(raw);
            
            const docInfo = {
                title: 'Soil Health Report - Krishi Mitra',
                generatedAt: new Date().toLocaleString(),
                content: snapshot
            };
            // create PDF via jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit:'pt', format:'a4'});
            doc.setFontSize(16);
            doc.text(docInfo.title, 40, 60);
            doc.setFontSize(10);
            doc.text('Generated: ' + docInfo.generatedAt, 40, 80);

            const values = (snapshot.values || snapshot.res?.values) || {
                ph: phEl.value, n: nEl.value, p: pEl.value, k: kEl.value,
                moisture: mEl.value, oc: ocEl.value, soilType: soilTypeEl.value, 
                farmerName: farmerNameEl.value, plannedCrop: plannedCropEl.value, rainfall: rainfallEl.value
            };

            let y = 110;
            doc.setFontSize(12);
            doc.text('Field: ' + (values.farmerName || 'â€”') + ' | Target Crop: ' + (values.plannedCrop || 'â€”'), 40, y); y+=18;
            doc.text('pH: ' + (values.ph || 'â€”') + '    N: ' + (values.n || 'â€”') + '    P: ' + (values.p || 'â€”') + '    K: ' + (values.k || 'â€”'), 40, y); y+=18;
            doc.text('Moisture: ' + (values.moisture || 'â€”') + '%    OC: ' + (values.oc || 'â€”') + '%    Soil type: ' + (values.soilType || 'â€”'), 40, y); y+=22;
            doc.text('Rainfall Forecast: ' + (values.rainfall || 'â€”'), 40, y); y+=22;

            if(snapshot.res){
                doc.setFontSize(11);
                doc.text('Observations:', 40, y); y+=14;
                snapshot.res.notes.forEach(line=>{
                    doc.text('- ' + line, 52, y); y+=14;
                });
                y+=6;
                if(snapshot.res.rec && snapshot.res.rec.length){
                    doc.text('Actions:', 40, y); y+=14;
                    snapshot.res.rec.forEach(line => { doc.text('- ' + line, 52, y); y+=14; });
                }
            } else {
                doc.text('No analysis snapshot found. Please run Analyze and Save before exporting for best result.', 40, y);
            }

            doc.save('soil-report-krishi-mitra.pdf');
        });

        // File parse button (try to extract numbers)
        document.getElementById('parseBtn').addEventListener('click', async ()=>{
            const fileInput = document.getElementById('fileUpload');
            if(!fileInput.files || fileInput.files.length === 0){ showMessage('Choose a file first (PDF/TXT).', true); return; }
            const file = fileInput.files[0];
            const name = file.name.toLowerCase();
            // Simple txt/doc: read as text
            if(/\.txt$/.test(name) || /\.csv$/.test(name) || /\.json$/.test(name)){
                const txt = await file.text();
                applyExtracted(txt);
            } else if(/\.pdf$/.test(name)){
                // browser cannot parse PDF text without PDFjs
                showMessage('PDF parsing in-browser is limited. If your PDF is text-based, paste the text into a text file and try the upload. Alternatively paste values in the form.', true);
            } else {
                showMessage('File type not supported for auto-parse. Try TXT or paste values.', true);
            }
        });

        function applyExtracted(text){
            // look for patterns
            const patterns = {
                ph: /pH[:\s]*([0-9]\.?[0-9]?)/i,
                n: /nitro(gen)?[:\s]*([0-9]{1,4})/i,
                p: /phosphor(us|us\))?[:\s]*([0-9]{1,4})/i,
                k: /potassi(um)?[:\s]*([0-9]{1,4})/i,
                oc: /organic\s+carbon[:\s]*([0-9]\.?[0-9]?)/i,
                moisture: /moisture[:\s]*([0-9]{1,3}\.?[0-9]?)/i
            };
            let foundAny=false;
            for(const key in patterns){
                const m = text.match(patterns[key]);
                if(m){
                    foundAny=true;
                    const val = m[1] ? m[1] : m[2];
                    if(key==='ph') phEl.value = val;
                    if(key==='n') nEl.value = m[2] || m[1];
                    if(key==='p') pEl.value = m[2] || m[1];
                    if(key==='k') kEl.value = m[2] || m[1];
                    if(key==='oc') ocEl.value = val;
                    if(key==='moisture') mEl.value = val;
                }
            }
            // Simple soil type extraction (can be improved)
            const soilm = text.match(/(sandy|loamy|clay|black|red)\s+soil/i);
            if(soilm){ soilTypeEl.value = soilm[1]; foundAny=true; }
            
            if(foundAny) showMessage('Parsed values applied to the form. Please review and press Analyze.');
            else showMessage('No recognisable values found. Try a plain-text report or paste the values manually.', true);
        }

        // Voice input using Web Speech API
        document.getElementById('voiceBtn').addEventListener('click', ()=>{
            const supported = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
            if(!supported){ showMessage('Voice input not supported in this browser.', true); return; }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'en-IN';
            rec.interimResults = false;
            rec.maxAlternatives = 1;
            rec.start();
            showMessage('Listening... Say values like: "pH 7.2 nitrogen 120 phosphorus 30 potassium 90 moisture 18 organic carbon 0.7 soil loamy crop wheat"');
            rec.onresult = (ev) => {
                const t = ev.results[0][0].transcript;
                hideMessage();
                // simple parse: look for numbers
                const phm = t.match(/pH\s*([0-9]\.?[0-9]?)/i);
                if(phm) phEl.value = phm[1];
                const nm = t.match(/nitro(gen)?\s*([0-9]{1,4})/i);
                if(nm) nEl.value = nm[2];
                const pm = t.match(/phosphor(us)?\s*([0-9]{1,4})/i);
                if(pm) pEl.value = pm[2];
                const km = t.match(/potassiu[mn]?\s*([0-9]{1,4})/i);
                if(km) kEl.value = km[1];
                const moc = t.match(/moisture\s*([0-9]{1,3}(\.[0-9]+)?)/i);
                if(moc) mEl.value = moc[1];
                const ocm = t.match(/organic\s*carbon\s*([0-9]\.?[0-9]?)/i);
                if(ocm) ocEl.value = ocm[1];
                const soilm = t.match(/soil\s*(sandy|loamy|clay|black|red)/i);
                if(soilm) soilTypeEl.value = soilm[1];
                const cropm = t.match(/crop\s*(wheat|rice|sugarcane|maize|cotton|tomato)/i);
                if(cropm) plannedCropEl.value = cropm[1].charAt(0).toUpperCase() + cropm[1].slice(1);
                
                showMessage('Voice parsed â€” please review fields then click Analyze.');
                rec.stop();
            };
            rec.onerror = (e) => { showMessage('Voice recognition error: ' + e.error, true); rec.stop(); }
        });

        // Auto load last saved on page open
        const last = localStorage.getItem('krishi_soil_last');
        if(last){
            try{
                const parsed = JSON.parse(last);
                if(parsed.values){
                    const vals = parsed.values;
                    // prefill fields
                    phEl.value = vals.ph || '';
                    nEl.value = vals.n || '';
                    pEl.value = vals.p || '';
                    kEl.value = vals.k || '';
                    mEl.value = vals.moisture || '';
                    ocEl.value = vals.oc || '';
                    soilTypeEl.value = vals.soilType || '';
                    farmerNameEl.value = vals.farmerName || '';
                    plannedCropEl.value = vals.plannedCrop || ''; // NEW
                    rainfallEl.value = vals.rainfall || ''; // NEW
                    
                    showMessage('Loaded last saved test. Press Analyze to review recommendations.');
                }
            }catch(e){}
        }

    })();
    </script>
</body>
</html>